<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniNav - Live Navigation</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

</head>
<body>
  <!-- Navigation Header -->
  <div class="nav-header">
    <h2>üß≠ Live Navigation</h2>
    <div class="nav-info">
      <div id="distance-display" class="distance-info">Calculating...</div>
      <div id="location-accuracy" class="location-accuracy">GPS: Searching...</div>
    </div>
    
    <div class="navigation-controls">
      <button id="track-btn" class="control-btn active" onclick="toggleTracking()">üìç Tracking</button>
      <button id="center-btn" class="control-btn inactive" onclick="centerOnUser()">üéØ Center</button>
      <button class="control-btn danger" onclick="sendPanic()">üö® SOS</button>
    </div>
  </div>

  <!-- Arrival Alert -->
  <div id="arrival-alert" class="arrival-alert">
    üéâ You have arrived at your destination!
  </div>

  <!-- Map -->
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    let userLocationMarker;
    let routePolyline;
    let destinationMarker;
    let accuracyCircle;
    let isTracking = true;
    let watchId = null;
    let hasArrived = false;
    
    const routeCoords = JSON.parse('{{ route_coords|default([])|tojson|safe }}');
    const destinationCoords = "{{ destination_coords|default('') }}";

    // Initialize map
    function initMap() {
      if (!routeCoords || routeCoords.length === 0) {
        alert("No route data available. Please go back and plan a route first.");
        window.history.back();
        return;
      }

      // Initialize map centered on route start
      map = L.map('map').setView([routeCoords[0][1], routeCoords[0][0]], 18);

      // Add map tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 19
      }).addTo(map);

      // Draw route
      const latlngs = routeCoords.map(coord => [coord[1], coord[0]]);
      routePolyline = L.polyline(latlngs, {
        color: '#0078ff',
        weight: 6,
        opacity: 0.8
      }).addTo(map);

      // Add destination marker
      const destPos = latlngs[latlngs.length - 1];
      destinationMarker = L.marker(destPos, {
        icon: L.icon({
          iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDOC4xMyAyIDUgNS4xMyA1IDlDNSAxNC4yNSAxMiAyMiAxMiAyMkMxMiAyMiAxOSAxNC4yNSAxOSA5QzE5IDUuMTMgMTUuODcgMiAxMiAyWiIgZmlsbD0iI2ZmNDQ0NCIgc3Ryb2tlPSIjZGQyMjIyIiBzdHJva2Utd2lkdGg9IjIiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSI5IiByPSIzIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
          iconSize: [30, 30],
          iconAnchor: [15, 30]
        })
      }).addTo(map).bindPopup("üéØ Destination");

      // Start location tracking
      startLocationTracking();
    }

    // Start real-time location tracking
    function startLocationTracking() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by this browser.");
        return;
      }

      const options = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 1000
      };

      watchId = navigator.geolocation.watchPosition(
        updateUserLocation,
        handleLocationError,
        options
      );
    }

    // Update user location
    function updateUserLocation(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const accuracy = position.coords.accuracy;

      // Update location on server
      fetch('/update_location', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ lat: lat, lng: lng, accuracy: accuracy })
      })
      .then(response => response.json())
      .then(data => {
        if (data.distance_to_destination !== null) {
          updateDistanceDisplay(data.distance_to_destination);
        }
      })
      .catch(error => console.error('Error updating location:', error));

      // Update accuracy display
      document.getElementById("location-accuracy").innerHTML = 
        `GPS: ¬±${Math.round(accuracy)}m`;

      // Remove old markers and circles
      if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
      }
      if (accuracyCircle) {
        map.removeLayer(accuracyCircle);
      }

      // Add new user location marker
      userLocationMarker = L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiMwMDc4ZmYiIHN0cm9rZT0iIzAwNTZiMyIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjQiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        })
      }).addTo(map);

      // Add accuracy circle if reasonable accuracy
      if (accuracy < 50) {
        accuracyCircle = L.circle([lat, lng], {
          radius: accuracy,
          fillColor: '#0078ff',
          fillOpacity: 0.1,
          color: '#0078ff',
          weight: 1
        }).addTo(map);
      }

      // Auto-center map on user (if tracking is enabled)
      if (isTracking) {
        map.setView([lat, lng], map.getZoom());
      }
    }

    // Update distance display
    function updateDistanceDisplay(distanceMeters) {
      let distanceText;
      
      if (distanceMeters < 1000) {
        distanceText = `${Math.round(distanceMeters)}m to go`;
      } else {
        distanceText = `${(distanceMeters / 1000).toFixed(1)}km to go`;
      }
      
      document.getElementById("distance-display").innerHTML = distanceText;
      
      // Check if arrived (within 15 meters)
      if (distanceMeters < 15 && !hasArrived) {
        hasArrived = true;
        showArrivalAlert();
        stopLocationTracking();
      }
    }

    // Show arrival alert
    function showArrivalAlert() {
      document.getElementById("arrival-alert").style.display = "block";
      
      // Play arrival sound (if supported)
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUaAkCY3O/OfCkEKoPM7taJOAcZaLvt559NEAxQpuPwtmMcCDiS2O7MeSsFJHfH8N2QQAoTXrTp66hVFApGn+DyvmUaAkCY3O/OfCkEKoPN7daOOQoTYqnl7K1CZNwAAADf5x9xT6R3AAAARADYCAAbAAB2UEYvlWHHqJgvNzY0mLKBvSU5f43Y6rJCYgYGAABnBzDJFkR9n8dAAAMGVxAAApQi4wCDAQCkAABNCjF5AAAFAAD9CgCe5A8kAIIAAIhAAOLmCrEAECgfaKwADNQCQKuCOtAAEKIKIKoEOMgBQCZgAAADQCcCdQBAOQCuAAEAABhYAh4GAHQgAh7cAABNAABkMAAKdQJQOgAXgwFUOgAhQmJgABAAAOsARABN1AAEBAB9AgEAAAApAABWAAAOoAbOAABbAAADAAAADQAA');
        audio.play();
      } catch (e) {
        // Audio not supported or failed
      }
      
      // Vibrate if supported
      if ('vibrate' in navigator) {
        navigator.vibrate([200, 100, 200]);
      }
      
      setTimeout(() => {
        if (confirm("üéâ You've arrived! Would you like to plan a new route?")) {
          window.location.href = '/directions';
        }
      }, 2000);
    }

    // Toggle location tracking
    function toggleTracking() {
      isTracking = !isTracking;
      const btn = document.getElementById("track-btn");
      
      if (isTracking) {
        btn.className = "control-btn active";
        btn.innerHTML = "üìç Tracking";
        startLocationTracking();
      } else {
        btn.className = "control-btn inactive";
        btn.innerHTML = "üìç Paused";
        stopLocationTracking();
      }
    }

    // Stop location tracking
    function stopLocationTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }

    // Center map on user location
    function centerOnUser() {
      if (userLocationMarker) {
        const pos = userLocationMarker.getLatLng();
        map.setView([pos.lat, pos.lng], 18);
        
        // Visual feedback
        const btn = document.getElementById("center-btn");
        btn.className = "control-btn active";
        btn.innerHTML = "üéØ Centered";
        
        setTimeout(() => {
          btn.className = "control-btn inactive";
          btn.innerHTML = "üéØ Center";
        }, 1000);
      }
    }

    // Handle location errors
    function handleLocationError(error) {
      let message = '';
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message = "Location access denied";
          break;
        case error.POSITION_UNAVAILABLE:
          message = "Location unavailable";
          break;
        case error.TIMEOUT:
          message = "Location timeout";
          break;
        default:
          message = "Location error";
          break;
      }
      
      document.getElementById("location-accuracy").innerHTML = `GPS: ${message}`;
      console.error("Location error: " + message);
    }

    // Send panic alert
    function sendPanic() {
      if (confirm("üö® Send emergency alert with your current location?")) {
        fetch('/panic', {method: 'POST'})
          .then(response => response.json())
          .then(data => alert(data.message))
          .catch(error => alert("Error sending panic alert."));
      }
    }

    // Initialize when page loads
    document.addEventListener("DOMContentLoaded", () => {
      initMap();
    });

    // Clean up when page is unloaded
    window.addEventListener('beforeunload', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }
    });

    // Prevent screen from sleeping during navigation
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
        }
      } catch (err) {
        console.log('Wake lock failed:', err);
      }
    }

    // Request wake lock when navigation starts
    requestWakeLock();

    // Handle visibility change
    document.addEventListener('visibilitychange', () => {
      if (wakeLock !== null && document.visibilityState === 'visible') {
        requestWakeLock();
      }
    });
  </script>

  <!-- Back button -->
  <div style="position: fixed; bottom: 20px; left: 20px;">
    <button onclick="window.history.back()" class="control-btn inactive">
      ‚Üê Back
    </button>
  </div>

</body>
</html>