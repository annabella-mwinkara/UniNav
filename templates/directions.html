<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniNav - Your Navigation Partner</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav>
    <button class="nav-toggle" aria-label="Toggle navigation" onclick="toggleNav()">☰</button>
    <div class="logo"><a href="{{ url_for('login') }}">UniNav</a></div>
    <div class="nav-links" id="navLinks">
      <a href="{{ url_for('login') }}">Home</a>
      <a href="{{ url_for('directions') }}">Directions</a>
      <a href="{{ url_for('maps') }}">Maps</a>
      {% if session.get('user_email') %}
      <button type="button" class="nav-profile-btn" onclick="openProfileModal()">👤 Profile</button>
      {% endif %}
    </div>
    <button class="panic-button" onclick="sendPanic()">🚨 SOS Panic</button>
  </nav>

  <script>
    function toggleNav(){
      const el = document.getElementById('navLinks');
      el.classList.toggle('open');
    }

    let panicInterval = null;
    let panicActive = false;

    function sendPanic() {
      if (panicActive) {
        // Stop panic mode
        clearInterval(panicInterval);
        panicActive = false;
        fetch('/panic', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'stop'})
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          updatePanicButton();
        });
      } else {
        // Start panic mode
        panicActive = true;
        
        // Send first alert immediately
        fetch('/panic', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'start'})
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          updatePanicButton();
          
          // Set interval for every 5 minutes
          panicInterval = setInterval(() => {
            fetch('/panic', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({action: 'start'})
            })
            .then(response => response.json())
            .then(data => console.log('Panic alert sent:', data.message));
          }, 300000); // 5 minutes
        })
        .catch(error => {
          alert("Error sending panic alert.");
          panicActive = false;
          updatePanicButton();
        });
      }
    }

    function updatePanicButton() {
      const buttons = document.querySelectorAll('.panic-button');
      buttons.forEach(btn => {
        if (panicActive) {
          btn.innerHTML = '🛑 Stop Alerts';
          btn.style.background = '#ff6600';
        } else {
          btn.innerHTML = '🚨 SOS Panic';
          btn.style.background = 'red';
        }
      });
    }

    // ✅ Use My Location button
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("useLocBtn").addEventListener("click", () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const coords = pos.coords.latitude + "," + pos.coords.longitude;
              document.getElementById("current").value = coords;

              // Save location to session via AJAX
              fetch("/save_location", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ location: coords })
              });
            },
            () => alert("Unable to fetch location")
          );
        } else {
          alert("Geolocation not supported by this browser.");
        }
      });
    });
  </script>

  <!-- Route Form -->
  <div class="form-card route-card">
    <h2>🗺️ Plan Your Route</h2>
    <form action="{{ url_for('directions') }}" method="post">
      <label for="current">Current Location:</label>
      <div class="input-row">
        <input type="text" id="current" name="current" placeholder="Place name or 'lat,lon'" required>
        <button type="button" class="ghost-btn" id="useLocBtn">Use My Location</button>
      </div>

      <label for="destination">Destination:</label>
      <input type="text" id="destination" name="destination" placeholder="Place name or 'lat,lon'" required>

      <div class="hint">Tip: You can type a place name (e.g., "UCC Library") or coordinates ("lat,lon").</div>

      <button type="submit" class="primary-btn">➡️ Get Directions</button>
    </form>
  </div>

  <!-- Summary Box -->
  {% if summary %}
  <div class="summary-box">
    <div><strong>🚶 Distance:</strong> {{ summary.distance_km }} km</div>
    <div><strong>⏱ Duration:</strong> {{ summary.duration_min }} minutes</div>
  </div>
  {% endif %}

  <!-- Directions Results -->
  {% if route_coords %}
  <div class="directions-card">
    <h3>📍 Route Map</h3>
    <div id="map" style="height: 400px; width: 100%; border-radius: 8px; margin-bottom: 20px;"></div>
    
    {% if steps %}
    <h3>📝 Step-by-Step Directions</h3>
    <div class="steps-list">
      {% for step in steps %}
      <div class="step-item">
        <div class="step-number">{{ loop.index }}</div>
        <div class="step-text">{{ step.instruction }}</div>
        {% if step.distance_m %}
        <div class="step-distance">{{ step.distance_m }}m</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {% else %}
  <div class="directions-card">
    <h3>📍 Campus Map</h3>
    <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
    <p class="map-hint">Enter your locations above to see the route on the map.</p>
  </div>
  {% endif %}

<script>
    var defaultLat = 5.6037;  // Example: Accra center
    var defaultLon = -0.1870;

    var map = L.map('map').setView([
        {% if route_coords %}
            {{ route_coords[0][1] }}, {{ route_coords[0][0] }}
        {% else %}
            defaultLat, defaultLon
        {% endif %}
    ], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    {% if route_coords %}
    var latlngs = [
    {% for coord in route_coords %}
        [{{ coord[1] }}, {{ coord[0] }}],
    {% endfor %}
    ];

    var polyline = L.polyline(latlngs, {color: 'blue'}).addTo(map);
    map.fitBounds(polyline.getBounds());
    L.marker(latlngs[0]).addTo(map).bindPopup("Start").openPopup();
    L.marker(latlngs[latlngs.length-1]).addTo(map).bindPopup("Destination");
    {% endif %}
</script>


  <footer>
    <p>© 2025 UniNav. All Rights Reserved.</p>
  </footer>
</body>
</html>
