<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniNav - Your Navigation Partner</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav>
    <button class="nav-toggle" aria-label="Toggle navigation" onclick="toggleNav()">â˜°</button>
    <div class="logo"><a href="{{ url_for('login') }}">UniNav</a></div>
    <div class="nav-links" id="navLinks">
      <a href="{{ url_for('login') }}">Home</a>
      <a href="{{ url_for('directions') }}">Directions</a>
      <a href="{{ url_for('maps') }}">Maps</a>
      {% if session.get('user_email') %}
      <button type="button" class="nav-profile-btn" onclick="openProfileModal()">ğŸ‘¤ Profile</button>
      {% endif %}
    </div>
    <button class="panic-button" onclick="sendPanic()">ğŸš¨ SOS Panic</button>
  </nav>

  <script>
    function toggleNav(){
      const el = document.getElementById('navLinks');
      el.classList.toggle('open');
    }

    let panicInterval = null;
    let panicActive = false;

    function sendPanic() {
      if (panicActive) {
        // Stop panic mode
        clearInterval(panicInterval);
        panicActive = false;
        fetch('/panic', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'stop'})
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          updatePanicButton();
        });
      } else {
        // Start panic mode
        panicActive = true;
        
        // Send first alert immediately
        fetch('/panic', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'start'})
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          updatePanicButton();
          
          // Set interval for every 5 minutes
          panicInterval = setInterval(() => {
            fetch('/panic', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({action: 'start'})
            })
            .then(response => response.json())
            .then(data => console.log('Panic alert sent:', data.message));
          }, 300000); // 5 minutes
        })
        .catch(error => {
          alert("Error sending panic alert.");
          panicActive = false;
          updatePanicButton();
        });
      }
    }

    function updatePanicButton() {
      const buttons = document.querySelectorAll('.panic-button');
      buttons.forEach(btn => {
        if (panicActive) {
          btn.innerHTML = 'ğŸ›‘ Stop Alerts';
          btn.style.background = '#ff6600';
        } else {
          btn.innerHTML = 'ğŸš¨ SOS Panic';
          btn.style.background = 'red';
        }
      });
    }

    // âœ… Use My Location button
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("useLocBtn").addEventListener("click", () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const coords = pos.coords.latitude + "," + pos.coords.longitude;
              document.getElementById("current").value = coords;

              // Save location to session via AJAX
              fetch("/save_location", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ location: coords })
              });
            },
            () => alert("Unable to fetch location")
          );
        } else {
          alert("Geolocation not supported by this browser.");
        }
      });
    });
  </script>

  <!-- Route Form -->
  <div class="form-card route-card">
    <h2>ğŸ—ºï¸ Plan Your Route</h2>
    <form action="{{ url_for('directions') }}" method="post">
      <label for="current">Current Location:</label>
      <div class="input-row">
        <input type="text" id="current" name="current" placeholder="Place name or 'lat,lon'" required>
        <button type="button" class="ghost-btn" id="useLocBtn">Use My Location</button>
      </div>

      <label for="destination">Destination:</label>
      <input type="text" id="destination" name="destination" placeholder="Place name or 'lat,lon'" required>

      <div class="hint">Tip: You can type a place name (e.g., "UCC Library") or coordinates ("lat,lon").</div>

      <button type="submit" class="primary-btn">â¡ï¸ Get Directions</button>
    </form>
  </div>

  <!-- Summary Box -->
  {% if summary %}
  <div class="summary-box">
    <div><strong>ğŸš¶ Distance:</strong> {{ summary.distance_km }} km</div>
    <div><strong>â± Duration:</strong> {{ summary.duration_min }} minutes</div>
    <div style="margin-top: 10px;">
      <a href="{{ url_for('navigate') }}" class="primary-btn">ğŸ§­ Start Navigation</a>
    </div>
  </div>
  {% endif %}

  <!-- Directions Results -->
  {% if route_coords %}
  <div class="directions-card">
    <h3>ğŸ“ Route Map</h3>
    <div id="map" style="height: 400px; width: 100%; border-radius: 8px; margin-bottom: 20px;"></div>
    
    {% if steps %}
    <h3>ğŸ“ Step-by-Step Directions</h3>
    <div class="steps-list">
      {% for step in steps %}
      <div class="step-item">
        <div class="step-number">{{ loop.index }}</div>
        <div class="step-text">{{ step.instruction }}</div>
        {% if step.distance_m %}
        <div class="step-distance">{{ step.distance_m }}m</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  <!-- {% else %}
  <div class="directions-card">
    <h3>ğŸ“ Campus Map</h3>
    <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
    <p class="map-hint">Enter your locations above to see the route on the map.</p>
  </div>
  {% endif %} -->

  <!-- Instructions List -->
  {% if directions %}
  <div class="directions-card">
    <h3>ğŸ“‹ Step-by-Step Directions</h3>
    <ol>
      {% for step in directions %}
      <li>{{ step }}</li>
      {% endfor %}
    </ol>
  </div>
  {% endif %}

 <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
     let map;
let userLocationMarker;
let routePolyline;
let isTracking = false;
let watchId = null;

// âœ… Safely load route_coords from Flask (or default empty list)
let routeCoords = [];
try {
  routeCoords = {{ route_coords | default([]) | tojson | safe }};
  console.log("Route coordinates loaded:", routeCoords);
} catch (e) {
  console.error("Error loading route coordinates:", e);
  routeCoords = [];
}


// âœ… Initialize map
function initMap() {
  const defaultLat = 5.6037;  // Accra center
  const defaultLon = -0.1870;

  // Start centered at Accra
  let initialLat = defaultLat;
  let initialLon = defaultLon;

  // If we have route coordinates, use the first point as center
  if (routeCoords && routeCoords.length > 0) {
    initialLat = routeCoords[0][1]; // lat
    initialLon = routeCoords[0][0]; // lon
  }

  // Create map
  map = L.map('map').setView([initialLat, initialLon], 16);

  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // âœ… Draw route only if available
  if (routeCoords && routeCoords.length > 0) {
    let latlngs = routeCoords.map(coord => [coord[1], coord[0]]); // Convert [lng, lat] â†’ [lat, lng]

    routePolyline = L.polyline(latlngs, { color: 'blue', weight: 5 }).addTo(map);
    map.fitBounds(routePolyline.getBounds());

    // Add start & destination markers
    L.marker(latlngs[0]).addTo(map).bindPopup("Start").openPopup();
    L.marker(latlngs[latlngs.length - 1]).addTo(map).bindPopup("Destination");

    // Start location tracking automatically
    startLocationTracking();
  } else {
    console.log("No route data available. Showing default map only.");
  }
}
    // Start real-time location tracking
    function startLocationTracking() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by this browser.");
        return;
      }

      isTracking = true;
      document.getElementById("location-status").style.display = "block";
      document.getElementById("track-btn").innerText = "Stop Tracking";

      const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      };

      watchId = navigator.geolocation.watchPosition(
        updateUserLocation,
        handleLocationError,
        options
      );
    }

    // Stop location tracking
    function stopLocationTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      
      isTracking = false;
      document.getElementById("location-status").style.display = "none";
      
      if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
        userLocationMarker = null;
      }
    }

    // Toggle location tracking
    function toggleLocationTracking() {
      if (isTracking) {
        stopLocationTracking();
      } else {
        startLocationTracking();
      }
    }

    // Update user location on map
    function updateUserLocation(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const accuracy = position.coords.accuracy;

      // Update location on server
      fetch('/update_location', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ lat: lat, lng: lng, accuracy: accuracy })
      })
      .then(response => response.json())
      .then(data => {
        if (data.distance_to_destination) {
          const distance = Math.round(data.distance_to_destination);
          document.getElementById("location-info").innerHTML = 
            `ğŸ“ Location updated | ğŸ¯ ${distance}m to destination`;
          
          // Alert if very close to destination
          if (distance < 20) {
            alert("ğŸ‰ You've arrived at your destination!");
            stopLocationTracking();
          }
        }
      });
    
      // Remove old marker
      if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
      }

      // Add new marker with accuracy circle
      userLocationMarker = L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiMwMDc4ZmYiIHN0cm9rZT0iIzAwNTZiMyIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjQiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        })
      }).addTo(map);

      // Add accuracy circle
      if (accuracy < 100) {
        L.circle([lat, lng], {
          radius: accuracy,
          fillColor: '#0078ff',
          fillOpacity: 0.1,
          color: '#0078ff',
          weight: 1
        }).addTo(map);
      }

      // Center map on user location if first update
      if (!map.hasBeenCentered) {
        map.setView([lat, lng], 18);
        map.hasBeenCentered = true;
      }
    }

    // Handle location errors
    function handleLocationError(error) {
      let message = '';
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message = "Location access denied by user.";
          break;
        case error.POSITION_UNAVAILABLE:
          message = "Location information is unavailable.";
          break;
        case error.TIMEOUT:
          message = "Location request timed out.";
          break;
        default:
          message = "An unknown error occurred.";
          break;
      }
      console.error("Location error: " + message);
      document.getElementById("location-info").innerHTML = "âŒ " + message;
    }

    // Panic button functionality
    function sendPanic() {
      fetch('/panic', {method: 'POST'})
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => alert("Error sending panic alert."));
    }

    // Use My Location button
    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      
      document.getElementById("useLocBtn").addEventListener("click", () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const coords = pos.coords.latitude + "," + pos.coords.longitude;
              document.getElementById("current").value = coords;

              // Save location to session via AJAX
              fetch("/save_location", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ location: coords })
              });
            },
            () => alert("Unable to fetch location")
          );
        } else {
          alert("Geolocation not supported by this browser.");
        }
      });
    });

    // Clean up when page is unloaded
    window.addEventListener('beforeunload', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }
    });
  </script>

  <footer>
    <p>Â© 2025 UniNav. All Rights Reserved.</p>
  </footer>
</body>
</html>